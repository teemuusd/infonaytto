<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tulli — infonäyttö</title>
<style>
  :root{--bg:#0b0c0d;--muted:#9aa0a6;--accent:#00bfb3;--feedback-bg:#1a1a2e}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Segoe UI,Arial,sans-serif}
  .wrap{display:grid;grid-template-columns:repeat(3, 1fr);gap:18px;padding:28px;box-sizing:border-box;height:100%}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:28px;letter-spacing:0.4px}
  .clock{font-size:20px;color:var(--muted)}
  .card{ background:rgba(255,255,255,0.03); border-radius:12px; padding:18px; display:flex; flex-direction:column; overflow: hidden; }
  .station-title{font-size:18px;color:var(--muted);margin-bottom:8px}
  .line-block{margin-bottom:12px}
  .line-title{font-weight:700;font-size:20px;margin-bottom:6px}
  .direction{font-size:16px;color:var(--muted);margin-bottom:6px}
  .departures{display:flex;flex-direction:column;gap:6px}
  .dep{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .dep .route{font-weight:700}
  .dep .time{font-size:18px}
  footer{grid-column:1/-1;color:var(--muted);font-size:13px;margin-top:6px}
  .now{color:#00bfb3;font-weight:700;}
  .feedback-card { background: var(--feedback-bg); grid-column: 3 / 4; }
  .feedback-title { color: var(--accent); font-size: 20px; margin-bottom: 15px; }
  .feedback-list { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
  .feedback-item { padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .feedback-item:last-child { border-bottom: none; padding-bottom: 0; }
  .feedback-content { font-size: 16px; line-height: 1.4; margin-bottom: 5px; }
  .feedback-author { font-style: italic; color: var(--muted); text-align: right; font-size: 14px; }
  .weather-widget { display: flex; align-items: center; gap: 10px; justify-content: flex-end; }
  .weather-temp { font-size: 24px; font-weight: bold; color: white; }
  .weather-desc { font-size: 16px; color: var(--muted); }
  @media(max-width:1200px){
    .wrap{grid-template-columns:1fr 1fr;}
    .feedback-card { grid-column: 1 / -1; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Tullin pysäkiltä lähtevät ratikat</h1>
      <div id="weather-content" class="weather-widget">
        <span class="weather-loading">Ladataan säätä...</span>
      </div>
      <div class="clock" id="clock">--:--</div>
    </header>

    <div class="card" id="card-A">
      <div class="station-title">Tulli A </div>
      <div id="content-A">Ladataan...</div>
    </div>

    <div class="card" id="card-B">
      <div class="station-title">Tulli B </div>
      <div id="content-B">Ladataan...</div>
    </div>
    
    <div class="card feedback-card">
      <div class="feedback-title">Positiiviset palautteet</div>
      <div id="feedback-display" class="feedback-list">
        Ladataan palautteita...
      </div>
    </div>

    <footer>Data: Nysse / Digitransit API • Päivittyy 10 s välein</footer>
  </div>

<script>
// --- ASETUKSET ---
// Uusi GraphQL päätepiste Tampereelle
var GRAPHQL_URL = 'api.digitransit.fi';
var STOP_A_CODE = 'Tampere:0811'; // Pysäkkikoodit uudessa järjestelmässä
var STOP_B_CODE = 'Tampere:0812';
var LINES_WANTED = ['1','3'];
var FEEDBACK_FILE = 'palautteet.json';
var WEATHER_URL = "api.open-meteo.com";


// --- Kellonaika ---
function updateClock(){
  var el = document.getElementById('clock');
  var now = new Date();
  el.textContent = [now.getHours(), now.getMinutes(), now.getSeconds()].map(function(n) { return n.toString().padStart(2, '0'); }).join(':');
}
setInterval(updateClock, 1000);
updateClock();


// --- HTTP Pyyntöfunktio (XMLHttpRequest, ES5 yhteensopiva) ---
function makeHttpRequest(url, callback, isGraphQL) {
    var xhr = new XMLHttpRequest();
    // Lisätään aikaleima URL:iin, jotta selain ei käytä välimuistia (Cache busting)
    var finalUrl = url + (url.indexOf('?') === -1 ? '?' : '&') + 't=' + new Date().getTime();

    if (isGraphQL) {
        // GraphQL käyttää POST-metodia ja lähettää kyselyn datana
        xhr.open('POST', url, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("Accept", "application/json");
    } else {
        xhr.open('GET', finalUrl, true);
    }
    
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var actualData = JSON.parse(xhr.responseText);
                    callback(null, actualData);
                } catch (e) {
                    callback(new Error('Virhe JSON-jäsennyksessä: ' + e.message), null);
                }
            } else {
                callback(new Error('HTTP-virhe: ' + xhr.status), null);
            }
        }
    };

    if (isGraphQL) {
        // Tämä data lähetetään POST-pyynnön mukana (ks. updateAll funkio)
        xhr.send(isGraphQL); 
    } else {
        xhr.send(null);
    }
}


// --- Pysäkkien logiikka (GraphQL haku ja käsittely) ---

function minutesUntil(timeInSeconds){
    // GraphQL antaa ajan sekunteina keskiyöstä, tämä muuntaa sen minuuteiksi nykyhetkestä
    var now = new Date();
    var departureDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, timeInSeconds);
    // Jos aika on jo mennyt tänään (esim. kello on 23:00 ja ratikka lähti 13:00), lisätään yksi päivä
    if (departureDate < now) {
        departureDate.setDate(departureDate.getDate() + 1);
    }
    var diffMs = departureDate - now;
    return Math.round(diffMs / 60000);
}

function renderFor(containerId, stopData){
    var el = document.getElementById(containerId);
    var departures = stopData ? stopData.stoptimesWithoutPatterns : [];

    if(!departures || departures.length === 0){
        el.innerHTML = '<div class="direction">Ei lähteviä vuoroja tiedossa.</div>';
        return;
    }

    var filtered = departures.filter(function(dep) {
        // GraphQL antaa linjanumeron (esim. "1") suoraan
        return LINES_WANTED.indexOf(dep.trip.route.shortName) !== -1 && minutesUntil(dep.realtimeDeparture) >= 0;
    });

    if(filtered.length === 0){
        el.innerHTML = '<div class="direction">Ei linjoja 1 tai 3 juuri nyt.</div>';
        return;
    }

    // Renderöinti pysyy samana, mutta data tulee hieman eri muodossa
    var html = '';
    filtered.slice(0, 5).forEach(function(item) {
        var mins = minutesUntil(item.realtimeDeparture);
        var arrivalStr = new Date(new Date().setHours(0,0,item.realtimeDeparture)).toLocaleTimeString('fi-FI', { hour: '2-digit', minute: '2-digit' });
        var timeLabel;
        
        if(mins <= 0){
            timeLabel = '<span class="now">nyt</span> (' + arrivalStr + ')';
        } else {
            timeLabel = mins + ' min' + ' (' + arrivalStr + ')';
        }
        
        html += '<div class="dep"><div class="route">Linja ' + item.trip.route.shortName + ' → ' + (item.headsign || '—') + '</div><div class="time">' + timeLabel + '</div></div>';
    });
    el.innerHTML = html;
}


function updateAll(){
    // GraphQL-kysely molemmille pysäkeille samanaikaisesti
    var query = JSON.stringify({
        query: `{
            stopA: stop(id: "${STOP_A_CODE}") {
                stoptimesWithoutPatterns(numberOfDepartures: 10) {
                    realtimeDeparture
                    headsign
                    trip { route { shortName } }
                }
            },
            stopB: stop(id: "${STOP_B_CODE}") {
                stoptimesWithoutPatterns(numberOfDepartures: 10) {
                    realtimeDeparture
                    headsign
                    trip { route { shortName } }
                }
            }
        }`
    });

    makeHttpRequest(GRAPHQL_URL, function(err, data) {
        if (err) {
            document.getElementById('content-A').innerHTML = '<div class="direction">Virhe: ' + err.message + '</div>';
            document.getElementById('content-B').innerHTML = '<div class="direction">Virhe: ' + err.message + '</div>';
        } else if (data.data) {
            renderFor('content-A', data.data.stopA);
            renderFor('content-B', data.data.stopB);
        } else {
             document.getElementById('content-A').innerHTML = '<div class="direction">API-virhe.</div>';
        }
    }, query); // Lähetetään query datana
}
updateAll();
setInterval(updateAll, 10000);


// --- Palautteet (Toimii suoraan GitHubissa) ---
function fetchAndDisplayFeedbacks() {
  makeHttpRequest(FEEDBACK_FILE, function(err, allFeedbacks) {
    var feedbackDisplayEl = document.getElementById('feedback-display');
    if (err) { console.error("Error fetching feedbacks:", err); feedbackDisplayEl.textContent = 'Virhe ladattaessa palautteita.'; return; }
    if (allFeedbacks && allFeedbacks.length > 0) {
      var newestFirst = allFeedbacks.reverse(); var html = '';
      newestFirst.forEach(function(feedback) { html += '<div class="feedback-item"><div class="feedback-content">"' + feedback.Palaute + '"</div><div class="feedback-author">— ' + (feedback.nimimerkki || 'Anonyymi') + '</div></div>'; });
      feedbackDisplayEl.innerHTML = html;
    } else { feedbackDisplayEl.textContent = 'Ei näytettäviä palautteita.'; }
  }, false); 
}
fetchAndDisplayFeedbacks();
setInterval(fetchAndDisplayFeedbacks, 30000);


// --- Sään haku (Toimii suoraan GitHubissa) ---
function loadWeather(){
  makeHttpRequest(WEATHER_URL, function(err, d) {
    var weatherWidgetEl = document.getElementById("weather-content");
    if (err) { console.error("Error fetching weather:", err); weatherWidgetEl.textContent = "Virhe ladattaessa säätä."; return; }
    
    var t = Math.round(d.current.temperature_2m);
    var code = d.current.weather_code;
    var descMap = { 0:"Selkeää", 1:"Melkein selkeää", 2:"Puolipilvistä", 3:"Pilvistä", 45:"Sumua", 48:"Jäätävää sumua", 51:"Tihkua", 61:"Vesisadetta", 71:"Lumikuuroja" };
    var desc = descMap[code] || "Säätietoja ei saatavilla";

    weatherWidgetEl.innerHTML = '<div class="weather-temp">' + t + '°C</div><div class="weather-desc">' + desc + '</div>';
  }, false); 
}
loadWeather();
setInterval(loadWeather, 900000);
</script>
</body>
</html>
