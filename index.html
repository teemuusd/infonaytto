<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tulli — infonäyttö</title>
<style>
  :root{--bg:#0b0c0d;--muted:#9aa0a6;--accent:#00bfb3;--feedback-bg:#1a1a2e}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Segoe UI,Arial,sans-serif}
  .wrap{display:grid;grid-template-columns:repeat(3, 1fr);gap:18px;padding:28px;box-sizing:border-box;height:100%}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:28px;letter-spacing:0.4px}
  .clock{font-size:20px;color:var(--muted)}
  .card{ background:rgba(255,255,255,0.03); border-radius:12px; padding:18px; display:flex; flex-direction:column; overflow: hidden; }
  .station-title{font-size:18px;color:var(--muted);margin-bottom:8px}
  .line-block{margin-bottom:12px}
  .line-title{font-weight:700;font-size:20px;margin-bottom:6px}
  .direction{font-size:16px;color:var(--muted);margin-bottom:6px}
  .departures{display:flex;flex-direction:column;gap:6px}
  .dep{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .dep .route{font-weight:700}
  .dep .time{font-size:18px}
  footer{grid-column:1/-1;color:var(--muted);font-size:13px;margin-top:6px}
  .now{color:#00bfb3;font-weight:700;}
  .feedback-card { background: var(--feedback-bg); grid-column: 3 / 4; }
  .feedback-title { color: var(--accent); font-size: 20px; margin-bottom: 15px; }
  .feedback-list { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
  .feedback-item { padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .feedback-item:last-child { border-bottom: none; padding-bottom: 0; }
  .feedback-content { font-size: 16px; line-height: 1.4; margin-bottom: 5px; }
  .feedback-author { font-style: italic; color: var(--muted); text-align: right; font-size: 14px; }
  .weather-widget { display: flex; align-items: center; gap: 10px; justify-content: flex-end; }
  .weather-temp { font-size: 24px; font-weight: bold; color: white; }
  .weather-desc { font-size: 16px; color: var(--muted); }
  @media(max-width:1200px){
    .wrap{grid-template-columns:1fr 1fr;}
    .feedback-card { grid-column: 1 / -1; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Tullin pysäkiltä lähtevät ratikat</h1>
      <div id="weather-content" class="weather-widget">
        <span class="weather-loading">Ladataan säätä...</span>
      </div>
      <div class="clock" id="clock">--:--</div>
    </header>

    <div class="card" id="card-A">
      <div class="station-title">Tulli A </div>
      <div id="content-A">Ladataan...</div>
    </div>

    <div class="card" id="card-B">
      <div class="station-title">Tulli B </div>
      <div id="content-B">Ladataan...</div>
    </div>
    
    <div class="card feedback-card">
      <div class="feedback-title">Positiiviset palautteet</div>
      <div id="feedback-display" class="feedback-list">
        Ladataan palautteita...
      </div>
    </div>

    <footer>Data: Nysse / ITS Factory Journeys API • Päivittyy 10 s välein</footer>
  </div>

<script>
// --- ASETUKSET ---
// Vaihdettu uuteen, luotettavampaan CORS-välityspalvelimeen
var PROXY_URL = 'api.allorigins.win';
var API_BASE = 'data.itsfactory.fi';
var STOP_A = '0811';
var STOP_B = '0812';
var LINES_WANTED = ['1','3'];
var FEEDBACK_FILE = 'palautteet.json';

// --- KELLO ---
function updateClock(){
  var el = document.getElementById('clock');
  var now = new Date();
  var hh = now.getHours().toString().padStart(2, '0');
  var mm = now.getMinutes().toString().padStart(2, '0');
  var ss = now.getSeconds().toString().padStart(2, '0');
  el.textContent = hh + ':' + mm + ':' + ss;
}
setInterval(updateClock, 1000);
updateClock();

// --- HTTP Pyyntöfunktio (XMLHttpRequest) ---
function makeHttpRequest(url, callback, useProxy) {
    var xhr = new XMLHttpRequest();
    var finalUrl = useProxy ? PROXY_URL + encodeURIComponent(url) : url;
    
    xhr.overrideMimeType("application/json"); // Tämä ei toimi proxyn kanssa, käsitellään vastauksessa
    xhr.open('GET', finalUrl + '&t=' + new Date().getTime(), true); 
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var rawData = JSON.parse(xhr.responseText);
                    // Proxin vastaus pitää purkaa erikseen content-osiosta
                    var actualData = useProxy ? JSON.parse(rawData.contents) : rawData;
                    callback(null, actualData);
                } catch (e) {
                    callback(new Error('Virhe JSON-jäsennyksessä: ' + e.message), null);
                }
            } else {
                callback(new Error('HTTP-virhe: ' + xhr.status), null);
            }
        }
    };
    xhr.send(null);
}

// --- PYSÄKKIEN LOGIIKKA (ES5 Yhteensopiva) ---
function normalizeJourneys(rawList){
  var out = []; var seen = {};
  (rawList || []).forEach(function(j) {
    var line = (j.line && (j.line.name || j.line.shortName)) || j.lineName || j.lineId || '';
    var headsign = j.headSign || j.destination || '';
    var departureISO = (j.onwardCalls && j.onwardCalls[0] && (j.onwardCalls[0].expectedDepartureTime || j.onwardCalls[0].expectedArrivalTime)) || j.expectedDepartureTime || j.departureTimeIso || null;
    if(!departureISO && j.departureTime){ var today = new Date(); var d = today.toISOString().slice(0,10); departureISO = d + 'T' + j.departureTime; }
    var key = line + '|' + headsign + '|' + departureISO;
    if(!seen[key]){ out.push({line: String(line).trim(), headsign: headsign || '', departureISO: departureISO}); seen[key] = true; }
  }); return out;
}
function minutesUntil(iso){
  if(!iso) return null; var t = Date.parse(iso);
  if(isNaN(t)) return null; return Math.round((t - Date.now()) / 60000);
}
function renderFor(containerId, journeys){
  var el = document.getElementById(containerId);
  if(!journeys || journeys.length === 0){ el.innerHTML = '<div class="direction">Ei lähteviä vuoroja tiedossa.</div>'; return; }
  var filtered = journeys.filter(function(j) { return LINES_WANTED.indexOf(String(j.line).replace(/\s/g,'')) !== -1 && minutesUntil(j.departureISO) >= 0; });
  if(filtered.length === 0){ el.innerHTML = '<div class="direction">Ei linjoja 1 tai 3 juuri nyt.</div>'; return; }
  var groups = {};
  filtered.forEach(function(j) { var key = j.line + ' — ' + (j.headsign || '—'); if (!groups[key]) groups[key] = []; groups[key].push(j); });
  var html = '';
  Object.keys(groups).sort().forEach(function(k) {
    var arr = groups[k].sort(function(a,b) { return minutesUntil(a.departureISO) - minutesUntil(b.departureISO); }).slice(0,5);
    var parts = k.split(' — '); var line = parts[0]; var headsign = parts[1];
    html += '<div class="line-block"><div class="line-title">Linja ' + line + '</div><div class="direction">' + headsign + '</div><div class="departures">';
    var nowShown = false;
    arr.forEach(function(item) {
      var mins = minutesUntil(item.departureISO); var arrivalTime = item.departureISO ? new Date(item.departureISO) : null;
      var arrivalStr = arrivalTime ? arrivalTime.getHours().toString().padStart(2,'0') + ':' + arrivalTime.getMinutes().toString().padStart(2,'0') : '—';
      var timeLabel;
      if(mins <= 0 && !nowShown){ timeLabel = '<span class="now">nyt</span> (' + arrivalStr + ')'; nowShown = true; } else { timeLabel = mins + ' min' + ' (' + arrivalStr + ')'; }
      html += '<div class="dep"><div class="route">' + line + ' → ' + (item.headsign || '—') + '</div><div class="time">' + timeLabel + '</div></div>';
    }); html += '</div></div>';
  }); el.innerHTML = html;
}

function updateAll(){
  // HUOM: Käytetään proxya Nysse APIssa CORS-ongelman takia
  makeHttpRequest(API_BASE + '/journeys?stopPointId=' + STOP_A + '&pageSize=200', function(err, dataA) {
    if (err) { document.getElementById('content-A').innerHTML = '<div class="direction">Virhe A: Tarkista verkko.</div>'; } 
    else { renderFor('content-A', normalizeJourneys(dataA.journeys || [])); }
  }, true); // Aseta true käyttääksesi proxya
  
  makeHttpRequest(API_BASE + '/journeys?stopPointId=' + STOP_B + '&pageSize=200', function(err, dataB) {
    if (err) { document.getElementById('content-B').innerHTML = '<div class="direction">Virhe B: Tarkista verkko.</div>'; } 
    else { renderFor('content-B', normalizeJourneys(dataB.journeys || [])); }
  }, true); // Aseta true käyttääksesi proxya
}
updateAll();
setInterval(updateAll, 10000);


// --- Palautteet (Toimii suoraan GitHubissa, ei tarvitse proxya) ---
function fetchAndDisplayFeedbacks() {
  makeHttpRequest(FEEDBACK_FILE, function(err, allFeedbacks) {
    var feedbackDisplayEl = document.getElementById('feedback-display');
    if (err) { console.error("Error fetching feedbacks:", err); feedbackDisplayEl.textContent = 'Virhe ladattaessa palautteita.'; return; }
    if (allFeedbacks && allFeedbacks.length > 0) {
      var newestFirst = allFeedbacks.reverse(); var html = '';
      newestFirst.forEach(function(feedback) { html += '<div class="feedback-item"><div class="feedback-content">"' + feedback.Palaute + '"</div><div class="feedback-author">— ' + (feedback.nimimerkki || 'Anonyymi') + '</div></div>'; });
      feedbackDisplayEl.innerHTML = html;
    } else { feedbackDisplayEl.textContent = 'Ei näytettäviä palautteita.'; }
  }, false); // Aseta false, koska ei tarvitse proxya omalle JSON-tiedostolle
}
fetchAndDisplayFeedbacks();
setInterval(fetchAndDisplayFeedbacks, 30000);


// --- Sään haku (Toimii suoraan GitHubissa, ei tarvitse proxya) ---
function loadWeather(){
  var url = "api.open-meteo.com";
  makeHttpRequest(url, function(err, d) {
    var weatherWidgetEl = document.getElementById("weather-content");
    if (err) { console.error("Error fetching weather:", err); weatherWidgetEl.textContent = "Virhe ladattaessa säätä."; return; }
    
    var t = Math.round(d.current.temperature_2m);
    var code = d.current.weather_code;
    var descMap = { 0:"Selkeää", 1:"Melkein selkeää", 2:"Puolipilvistä", 3:"Pilvistä", 45:"Sumua", 48:"Jäätävää sumua", 51:"Tihkua", 61:"Vesisadetta", 71:"Lumikuuroja" };
    var desc = descMap[code] || "Säätietoja ei saatavilla";

    weatherWidgetEl.innerHTML = '<div class="weather-temp">' + t + '°C</div><div class="weather-desc">' + desc + '</div>';
  }, false); // Aseta false, koska ei tarvitse proxya säärajapinnalle
}
loadWeather();
setInterval(loadWeather, 900000);
</script>
</body>
</html>
